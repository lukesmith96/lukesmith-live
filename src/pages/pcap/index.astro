---
/**
 * Network Anomaly Detection Dashboard - Main Page
 * Integrated with Luke Smith's portfolio design system
 */

import Layout from '@layouts/Layout.astro';
import UploadSection from '../../components/pcap/UploadSection.astro';
import DemoScenarios from '../../components/pcap/DemoScenarios.astro';
import ResultsDashboard from '../../components/pcap/ResultsDashboard.astro';
import NetworkGraph from '../../components/pcap/NetworkGraph.astro';
import '../../styles/pcap.css';

const pageTitle = "Network Anomaly Detection | Luke Smith";
const pageDescription = "Real-time PCAP analysis and threat detection system. Upload network packet captures to detect security threats including port scans, C2 beaconing, DNS tunneling, and more.";
---

<Layout title={pageTitle} description={pageDescription}>
    <!-- D3.js for network graphs -->
    <script is:inline src="https://d3js.org/d3.v7.min.js"></script>

    <main class="relative max-w-7xl mx-auto p-8 md:p-16 space-y-12">
        <!-- Header Section -->
        <header class="slide-enter space-y-4">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-4xl md:text-5xl font-bold text-skin-base">Network Anomaly Detection</h1>
                    <p class="text-skin-muted text-lg mt-2">Real-time PCAP analysis and threat detection</p>
                </div>
                <a href="/" class="text-skin-muted hover:text-skin-base transition-colors text-sm">
                    ← Back
                </a>
            </div>
        </header>

        <!-- Error Banner -->
        <div id="errorBanner" class="hidden slide-enter bg-red-500/10 border-2 border-red-500/30 rounded-lg p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span id="errorMessage" class="text-skin-base text-sm"></span>
                </div>
                <button onclick="document.getElementById('errorBanner').classList.add('hidden')" class="text-skin-muted hover:text-skin-base">✕</button>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="slide-enter-content grid grid-cols-1 lg:grid-cols-[400px_1fr] gap-8">
            <!-- Left Panel - Upload & Demos -->
            <div class="space-y-6">
                <UploadSection />
                <DemoScenarios />
            </div>

            <!-- Right Panel - Results Display -->
            <div class="bg-skin-fill/50 backdrop-blur-sm border border-skin-muted/20 rounded-lg p-6 md:p-8 min-h-[600px]">
                <ResultsDashboard />
                <NetworkGraph />
            </div>
        </div>

        <!-- Recent Analyses Section -->
        <div class="slide-enter-content bg-skin-fill/50 backdrop-blur-sm border border-skin-muted/20 rounded-lg p-6 md:p-8">
            <h2 class="text-3xl font-bold text-skin-base mb-6">Recent Analyses</h2>

            <div id="resultsLoading" class="text-skin-muted">Loading results...</div>

            <div id="resultsEmpty" class="hidden text-skin-muted">
                No analyses yet. Upload a PCAP file or run a demo to get started.
            </div>

            <div id="resultsGrid" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
        </div>

        <!-- Footer -->
        <footer class="slide-enter-content text-center text-sm text-skin-muted py-6">
            <p>
                Built with AWS Lambda, DynamoDB, and Astro |
                <a href="https://github.com/lukesmith96" class="text-skin-hue hover:underline">Open Source</a>
            </p>
        </footer>
    </main>
</Layout>

<style>
  /* Extend main site animations */
  @keyframes slide-enter {
    0% {
      transform: translateY(10px);
      opacity: 0;
    }
    to {
      transform: translateY(0);
      opacity: 1;
    }
  }

  @media (prefers-reduced-motion: no-preference) {
    .slide-enter {
      animation: slide-enter 0.6s ease-out;
    }

    .slide-enter-content > * {
      --enter-stage: 0;
      animation: slide-enter 0.8s both;
      animation-delay: calc(var(--enter-stage) * 150ms);
    }

    .slide-enter-content > *:nth-child(1) {
      --enter-stage: 1;
    }
    .slide-enter-content > *:nth-child(2) {
      --enter-stage: 2;
    }
    .slide-enter-content > *:nth-child(3) {
      --enter-stage: 3;
    }
    .slide-enter-content > *:nth-child(4) {
      --enter-stage: 4;
    }
  }
</style>

<script>
  import { getResults } from '../../lib/pcap-api';
  import type { AnalysisResult } from '../../lib/pcap-types';

  // State
  let results: AnalysisResult[] = [];
  let selectedResult: AnalysisResult | null = null;

  // Load results on page load
  loadResults();

  async function loadResults() {
    const loadingEl = document.getElementById('resultsLoading');
    const emptyEl = document.getElementById('resultsEmpty');
    const gridEl = document.getElementById('resultsGrid');

    try {
      const data = await getResults();
      results = data.results || [];

      loadingEl?.classList.add('hidden');

      if (results.length === 0) {
        emptyEl?.classList.remove('hidden');
        gridEl?.classList.add('hidden');
      } else {
        emptyEl?.classList.add('hidden');
        gridEl?.classList.remove('hidden');
        renderResults();
      }
    } catch (error: any) {
      showError('Failed to load results: ' + error.message);
      loadingEl?.classList.add('hidden');
    }
  }

  function renderResults() {
    const gridEl = document.getElementById('resultsGrid');
    if (!gridEl) return;

    gridEl.innerHTML = results.map((result) => {
      const isSelected = selectedResult?.analysis_id === result.analysis_id;
      return `
        <div
          class="bg-skin-fill/70 backdrop-blur-sm border-2 ${
            isSelected ? 'border-skin-hue' : 'border-skin-muted/20'
          } rounded-lg p-4 hover:border-skin-hue/50 transition-all cursor-pointer"
          onclick="selectResult('${result.analysis_id}')"
        >
          <div class="space-y-2">
            <div class="flex items-start justify-between gap-2">
              <h3 class="text-sm font-bold text-skin-base truncate flex-1">${result.filename}</h3>
              ${result.is_demo ? '<span class="text-xs px-2 py-1 bg-skin-hue/20 text-skin-hue rounded">DEMO</span>' : ''}
            </div>

            <div class="flex justify-between text-xs text-skin-muted">
              <span>Packets: ${result.packet_count?.toLocaleString()}</span>
              <span class="font-bold text-red-500">
                Threats: ${result.analysis_results?.total_threats || 0}
              </span>
            </div>

            <div class="text-xs text-skin-muted/70">
              ${new Date(result.timestamp * 1000).toLocaleString()}
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function selectResult(analysisId: string) {
    const result = results.find((r) => r.analysis_id === analysisId);
    if (result) {
      selectedResult = result;
      renderResults();

      // Dispatch event to update dashboard
      window.dispatchEvent(new CustomEvent('result-selected', { detail: result }));
    }
  }

  function showError(message: string) {
    const banner = document.getElementById('errorBanner');
    const messageEl = document.getElementById('errorMessage');
    if (banner && messageEl) {
      messageEl.textContent = message;
      banner.classList.remove('hidden');
    }
  }

  // Listen for upload complete
  window.addEventListener('pcap-upload-complete', () => {
    setTimeout(() => {
      loadResults();
    }, 2000);
  });

  // Listen for demo complete
  window.addEventListener('demo-complete', ((e: CustomEvent) => {
    const newResult = e.detail;
    results = [newResult, ...results];
    selectedResult = newResult;
    renderResults();

    // Update dashboard immediately
    window.dispatchEvent(new CustomEvent('result-selected', { detail: newResult }));
  }) as EventListener);

  // Listen for demo errors
  window.addEventListener('demo-error', ((e: CustomEvent) => {
    showError(e.detail.message);
  }) as EventListener);

  // Make selectResult available globally for onclick handlers
  (window as any).selectResult = selectResult;
</script>
