---
/**
 * Results Dashboard Component
 * Pure Astro component - dynamically updated via JavaScript
 */

const SEVERITY_ICONS: Record<string, string> = {
  critical: 'ðŸ”´',
  high: 'ðŸŸ ',
  medium: 'ðŸŸ¡',
  low: 'ðŸŸ¢',
};
---

<div id="resultsDashboard" class="hidden">
  <div class="space-y-6">
    <!-- Header -->
    <div class="border-b border-skin-muted/20 pb-4">
      <h2 id="resultFilename" class="text-3xl font-bold text-skin-base mb-2"></h2>
      <div class="flex gap-4 text-sm text-skin-muted">
        <span id="resultPackets"></span>
        <span id="resultTimestamp"></span>
      </div>
    </div>

    <!-- Summary Cards -->
    <div id="summaryCards" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>

    <!-- Detector Results -->
    <div id="detectorResults" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-5 gap-4"></div>

    <!-- Threat Details -->
    <div id="threatDetails"></div>
  </div>
</div>

<div id="emptyState" class="flex flex-col items-center justify-center h-full text-center min-h-[400px]">
  <svg xmlns="http://www.w3.org/2000/svg" class="h-24 w-24 text-skin-muted/20 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
  </svg>
  <h2 class="text-3xl font-bold text-skin-muted/50 mb-2">No Analysis Selected</h2>
  <p class="text-skin-muted">Upload a PCAP file or run a demo scenario to see results</p>
</div>

<script>
  const SEVERITY_ICONS: Record<string, string> = {
    critical: 'ðŸ”´',
    high: 'ðŸŸ ',
    medium: 'ðŸŸ¡',
    low: 'ðŸŸ¢',
  };

  function formatDetectorName(name: string) {
    return name
      .split('_')
      .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
      .join(' ');
  }

  function displayResult(result: any) {
    const dashboard = document.getElementById('resultsDashboard');
    const emptyState = document.getElementById('emptyState');
    const analysis = result.analysis_results;

    if (!analysis) {
      dashboard?.classList.add('hidden');
      emptyState?.classList.remove('hidden');
      return;
    }

    dashboard?.classList.remove('hidden');
    emptyState?.classList.add('hidden');

    // Update header
    const filename = document.getElementById('resultFilename');
    if (filename) filename.textContent = result.filename;

    const packets = document.getElementById('resultPackets');
    if (packets) packets.textContent = `Packets: ${result.packet_count?.toLocaleString()}`;

    const timestamp = document.getElementById('resultTimestamp');
    if (timestamp) timestamp.textContent = new Date(result.timestamp * 1000).toLocaleString();

    // Summary cards
    const summaryCards = document.getElementById('summaryCards');
    if (summaryCards) {
      let html = `
        <div class="bg-gradient-to-br from-red-500 to-orange-500 text-white rounded-lg p-4 border border-skin-muted/20">
          <div class="text-3xl font-bold mb-1">${analysis.total_threats}</div>
          <div class="text-sm opacity-90">Total Threats</div>
        </div>
      `;

      for (const [severity, count] of Object.entries(analysis.threats_by_severity || {})) {
        html += `
          <div class="bg-skin-fill/70 backdrop-blur-sm border border-skin-muted/20 rounded-lg p-4">
            <div class="text-2xl font-bold text-skin-base mb-1">${SEVERITY_ICONS[severity]} ${count}</div>
            <div class="text-sm text-skin-muted">${severity.toUpperCase()}</div>
          </div>
        `;
      }

      summaryCards.innerHTML = html;
    }

    // Detector results
    const detectorResults = document.getElementById('detectorResults');
    if (detectorResults && analysis.detector_results) {
      let html = '';
      for (const [detectorName, data] of Object.entries(analysis.detector_results) as any) {
        html += `
          <div class="bg-skin-fill/70 backdrop-blur-sm border border-skin-muted/20 rounded-lg p-4">
            <h3 class="text-sm font-bold text-skin-base mb-2">${formatDetectorName(detectorName)}</h3>
            ${
              data.threats_found > 0
                ? `
              <div class="flex items-center gap-2">
                <span class="px-2 py-1 bg-red-500/20 text-red-500 rounded text-xs font-medium">${data.threats_found}</span>
                <span class="text-xs text-skin-muted">threats</span>
              </div>
            `
                : '<span class="text-green-500 text-sm font-bold">âœ“ Clean</span>'
            }
          </div>
        `;
      }
      detectorResults.innerHTML = html;
    }

    // Threat details
    const threatDetails = document.getElementById('threatDetails');
    if (threatDetails && analysis.all_threats && analysis.all_threats.length > 0) {
      let html = '<div><h3 class="text-2xl font-bold text-skin-base mb-4">Detected Threats</h3><div class="space-y-4">';

      for (const threat of analysis.all_threats) {
        const severityColors = {
          critical: { bg: 'bg-red-500/10', border: 'border-red-500/30', badge: 'bg-red-500/20 text-red-500' },
          high: { bg: 'bg-orange-500/10', border: 'border-orange-500/30', badge: 'bg-orange-500/20 text-orange-500' },
          medium: { bg: 'bg-blue-500/10', border: 'border-blue-500/30', badge: 'bg-blue-500/20 text-blue-500' },
          low: { bg: 'bg-green-500/10', border: 'border-green-500/30', badge: 'bg-green-500/20 text-green-500' }
        };
        const colors = severityColors[threat.severity as keyof typeof severityColors] || severityColors.low;

        html += `
          <div class="border-2 rounded-lg p-4 ${colors.bg} ${colors.border}">
            <div class="flex-1">
              <div class="flex items-center justify-between mb-2">
                <h4 class="font-bold text-lg text-skin-base">
                  ${SEVERITY_ICONS[threat.severity]} ${formatDetectorName(threat.type)}
                </h4>
                <span class="px-2 py-1 rounded text-xs font-medium ${colors.badge}">${threat.severity.toUpperCase()}</span>
              </div>
              <p class="text-sm text-skin-base mb-2">${threat.description}</p>
              <div class="flex flex-wrap gap-2 text-xs">
                ${threat.source_ip ? `<span class="px-2 py-1 bg-skin-muted/20 text-skin-muted rounded">Source: ${threat.source_ip}</span>` : ''}
                ${threat.target_ip ? `<span class="px-2 py-1 bg-skin-muted/20 text-skin-muted rounded">Target: ${threat.target_ip}</span>` : ''}
                ${threat.destination_ip ? `<span class="px-2 py-1 bg-skin-muted/20 text-skin-muted rounded">Dest: ${threat.destination_ip}</span>` : ''}
                ${threat.ports_scanned ? `<span class="px-2 py-1 bg-skin-muted/20 text-skin-muted rounded">Ports: ${threat.ports_scanned}</span>` : ''}
                ${threat.beacon_count ? `<span class="px-2 py-1 bg-skin-muted/20 text-skin-muted rounded">Beacons: ${threat.beacon_count}</span>` : ''}
                ${threat.total_queries ? `<span class="px-2 py-1 bg-skin-muted/20 text-skin-muted rounded">Queries: ${threat.total_queries}</span>` : ''}
                ${threat.targets_contacted ? `<span class="px-2 py-1 bg-skin-muted/20 text-skin-muted rounded">Targets: ${threat.targets_contacted}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }

      html += '</div></div>';
      threatDetails.innerHTML = html;
    } else if (threatDetails) {
      threatDetails.innerHTML = '';
    }

    // Trigger network graph update
    window.dispatchEvent(new CustomEvent('update-network-graph', { detail: analysis.all_threats || [] }));
  }

  // Listen for result selection events
  window.addEventListener('result-selected', ((e: CustomEvent) => {
    displayResult(e.detail);
  }) as EventListener);

  // Make function available globally
  (window as any).displayResult = displayResult;
</script>
