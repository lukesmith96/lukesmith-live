---
/**
 * Interactive Demo Scenarios Component
 * Pure Astro component with vanilla JavaScript
 */

const SCENARIOS = [
  {
    id: 'port_scan',
    title: 'Port Scan Attack',
    description: 'Attacker scanning 50 ports on target',
    icon: 'ğŸ”',
    severity: 'high',
  },
  {
    id: 'c2_beaconing',
    title: 'C2 Beaconing',
    description: 'Regular connections to C2 server',
    icon: 'ğŸ“¡',
    severity: 'critical',
  },
  {
    id: 'dns_tunneling',
    title: 'DNS Tunneling',
    description: 'Data exfiltration via DNS queries',
    icon: 'ğŸŒ',
    severity: 'high',
  },
  {
    id: 'lateral_movement',
    title: 'Lateral Movement',
    description: 'Compromised host spreading internally',
    icon: 'â†”ï¸',
    severity: 'critical',
  },
  {
    id: 'traffic_spike',
    title: 'Traffic Spike',
    description: 'Sudden 25x traffic increase',
    icon: 'ğŸ“ˆ',
    severity: 'medium',
  },
];

function getSeverityColor(severity: string) {
  switch (severity) {
    case 'critical':
      return 'border-l-red-500 border-l-4';
    case 'high':
      return 'border-l-orange-500 border-l-4';
    case 'medium':
      return 'border-l-blue-500 border-l-4';
    default:
      return 'border-l-green-500 border-l-4';
  }
}
---

<div class="bg-skin-fill/50 backdrop-blur-sm border border-skin-muted/20 rounded-lg p-6">
  <h2 class="text-2xl font-bold text-skin-base mb-2">Interactive Demos</h2>
  <p class="text-skin-muted mb-4 text-sm">
    Click a scenario to generate and analyze synthetic attack traffic
  </p>

  <div class="space-y-3">
    {SCENARIOS.map((scenario) => (
      <button
        class={`w-full flex justify-start items-center h-auto py-4 px-4 text-left ${getSeverityColor(scenario.severity)} bg-skin-fill/70 hover:bg-skin-fill/90 rounded-lg transition-all border border-skin-muted/20 demo-scenario-btn`}
        data-scenario={scenario.id}
      >
        <span class="text-3xl mr-3">{scenario.icon}</span>
        <div class="flex-1">
          <h3 class="font-bold text-base text-skin-base">{scenario.title}</h3>
          <p class="text-xs text-skin-muted/70">{scenario.description}</p>
        </div>
      </button>
    ))}
  </div>

  <div id="demoLoading" class="hidden mt-4">
    <div class="flex items-center gap-3">
      <div class="inline-block h-4 w-4 animate-spin rounded-full border-2 border-solid border-skin-hue border-r-transparent"></div>
      <span class="text-sm text-skin-muted">Running demo scenario...</span>
    </div>
  </div>
</div>

<script>
  import { runDemoScenario } from '../../lib/pcap-api';

  const buttons = document.querySelectorAll('.demo-scenario-btn');
  const loadingEl = document.getElementById('demoLoading');
  let isRunning = false;

  buttons.forEach((button) => {
    button.addEventListener('click', async (e) => {
      if (isRunning) return;

      const scenario = (button as HTMLElement).dataset.scenario;
      if (!scenario) return;

      isRunning = true;
      buttons.forEach((btn) => btn.setAttribute('disabled', 'true'));
      loadingEl?.classList.remove('hidden');

      try {
        const result = await runDemoScenario(scenario);

        // Dispatch custom event with result data
        window.dispatchEvent(
          new CustomEvent('demo-complete', {
            detail: {
              analysis_id: result.analysis_id,
              filename: `demo_${scenario}.pcap`,
              packet_count: result.metadata?.packet_count || 0,
              timestamp: Date.now() / 1000,
              analysis_results: result.results,
              is_demo: true,
            },
          })
        );
      } catch (error: any) {
        window.dispatchEvent(
          new CustomEvent('demo-error', {
            detail: { message: `Failed to run demo: ${error.message}` },
          })
        );
      } finally {
        isRunning = false;
        buttons.forEach((btn) => btn.removeAttribute('disabled'));
        loadingEl?.classList.add('hidden');
      }
    });
  });
</script>
